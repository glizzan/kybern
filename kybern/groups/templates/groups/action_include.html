<div id="action_history" class="mt-3">

    <b-button variant="outline-secondary" v-b-modal.action_history_modal>view group history</b-button>

  <!-- Modal with more detailed info on all actions -->
  <b-modal id="action_history_modal" :title="title_string" class="modal fade" size="xl" @ok="handleOk">
     
    <b-container fluid id="action_history_table" v-if=!condition_type>   <!-- if condition is selected, replace table with ux for condition -->

          <b-col lg="6" class="my-1">
              <b-form-group label="Filter" label-cols-sm="3" label-align-sm="right" label-size="sm"
                                                              label-for="filterInput" class="mb-0">
                <b-input-group size="sm">
                  <b-form-input v-model="filter" type="search" id="filterInput" 
                                        placeholder="Type to Search"></b-form-input>
                  <b-input-group-append>
                    <b-button :disabled="!filter" @click="filter = ''">Clear</b-button>
                  </b-input-group-append>
                </b-input-group>
              </b-form-group>
            </b-col>

          <b-table striped hover fixed :items="actions" :fields="action_fields" 
              :sort-by.sync="sortBy" :sort-desc.sync="sortDesc" :filter="filter"
              :filterIncludedFields="filterOn" id="action_history_table_element">

            <!-- Custom formatting for the has_condition column -->
            <template v-slot:cell(has_condition)="data">
                <b-button v-if="data.item.has_condition && data.item.has_condition.exists" 
                    @click="launch_condition_modal(data.item)" size='sm'>view</b-button>
            </template>

          </b-table>

      </b-container>

      <approve-condition-ui v-if="condition_type=='ApprovalCondition'" :condition_pk=condition_pk
        :condition_type=condition_type :action_details=action_details>
      </approve-condition-ui>

      <vote-condition-ui v-if="condition_type=='VoteCondition'" :condition_pk=condition_pk
        :condition_type=condition_type :action_details=action_details>
      </vote-condition-ui>
      
  </b-modal>   
</div>

{% include 'groups/approve_condition_include.html' %}
{% include 'groups/vote_condition_include.html' %}

<script>

// Main vue instance for action history app
var actionHistoryApp = new Vue({
    delimiters: ['[[', ']]'],
    el: '#action_history',
    store,
    data: {
      action_fields: [
        { key: 'description', sortable: false },
        { key: 'actor', sortable: true },
        { key: 'created', sortable: true, formatter: (value, key, item) => {
              return item.display_date
            }
        },
        { key: 'status', sortable: true },
        { key: 'resolution passed by', sortable: true },
        { key: 'has_condition', sortable: true }
      ],
      sortBy: 'created',
      sortDesc: true,  
      filter: null,
      filterOn: [],
      // Info to pass to condition modal
      condition_type: null,
      condition_data: null,
      action_details: null
    },
    computed: {
      ...Vuex.mapState(['actions']),
      title_string: function() {
        if (this.condition_type == null) {
          return "Action history for {{ target.name }}"
        } else {
          return this.condition_type + " on action '" + this.action_details.description + "'"
        }
      }
    },
    methods: {
      handleOk(bvModalEvt) {
        bvModalEvt.preventDefault() // Prevent modal from closing
        this.condition_type = null    // clear state
        this.condition_pk = null
        this.action_details = null
      },
      launch_condition_modal(item) {  
        this.condition_type = item.has_condition.type
        this.condition_pk = item.has_condition.pk
        this.action_details = item
        }
    }
})

</script>
