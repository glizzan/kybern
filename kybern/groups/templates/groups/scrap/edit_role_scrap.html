<script type="text/x-template" id="edit_role_modal_template">

    <b-modal id="edit_role_modal" :title="edit_role_modal_title_string">

        <!-- Always existing permissions and the conditions that have been set on them. -->

        <h5>People with this role can: </h5>

        <b-list-group v-for="permission in permissions" v-bind:key="permission.id">
            <b-list-group-item>
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-primary"> 
                        <small>[[ permission.display ]]</small>
                        <span class="badge badge-light ml-1" 
                            v-on:click="edit_permission(permission.id, permission.change_type)">ðŸ–‰</span>
                    </button>
                    <button v-if="conditions[permission.id]" type="button" class="btn btn-warning">
                        <small>[[ conditions[permission.id].name ]]</small>
                        <span class="badge badge-light ml-1" 
                            v-on:click="edit_condition(permission.id)">ðŸ–‰</span>
                    </button>
                    <button v-else type="button" class="btn btn-warning" 
                                        v-on:click="add_condition(permission.id)">
                        <small>add condition</small>
                    </button>   
                </div>
                <span class="badge badge-secondary badge-pill" >
                    
                </span>
                </b-list-group-item>
        </b-list-group>

        <p v-if="!permissions.length">This role has no permissions yet.</p>

        <div class="mb-3" v-if="edit_role_error_message">
                [[ edit_role_error_message ]]
        </div>

        <!-- PERMISSIONS CONTENT -->
        <span v-if="edit_mode == 'permission'">

            <span v-if="update_or_create == 'create'">
                <h5>Add a new permission:</h5>
                <template><div>
                    <b-form-select v-model="permission_selected" :options="permission_options" :select-size="4">
                    </b-form-select>
                </div></template>
            </span>

            <span v-if="permission_selected">
                <h5 v-if="permission_configuration_fields.length > 0" class="my-3">Configure your permission</h5>
                <div class="input-group mb-3" v-for="(field, index) in permission_configuration_fields">        
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.name ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" 
                        aria-describedby="field.name label" v-model="permission_configuration_fields[index]['value']">
                </div>
            </span>

            <b-button v-if="permission_selected && update_or_create=='create'" size="sm" class="mt-5" variant="success"
                @click="addPermission()">Save permission</b-button>

            <b-button v-if="permission_selected && update_or_create=='update'" size="sm" class="mt-5" variant="success" 
                @click="updatePermission()">Save changes</b-button>

        </span>

        <!-- CONDITIONS CONTENT -->
        <span v-if="edit_mode == 'condition'">

            <span v-if="update_or_create == 'create'">
                <h5>Select condition to add:</h5>
                <template><div>
                    <b-form-select v-model="condition_selected" :options="condition_options" :select-size="4">
                    </b-form-select>
                </div></template>
            </span>

            <span v-if="condition_selected">
                <h5 v-if="condition_configuration_fields.length > 0" class="mb-3">Configure your condition</h5>
                <div class="input-group mb-3" v-for="(field, index) in condition_configuration_fields">   

                    <div v-if="field.type=='CharField'" class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="field.name label">[[ field.name ]]</span>
                        </div>
                        <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                            v-model="condition_configuration_fields[index]['value']" 
                            :required="condition_configuration_fields[index]['required']">
                    </div>

                    <span v-if="field.type=='BooleanField'">
                        <b-form-checkbox v-model="condition_configuration_fields[index]['value']" 
                            name="checkbox-1" value="True" unchecked-value="False">
                        [[ field.name]] </b-form-checkbox>
                    </span>

                    <div v-if="field.type=='FloatField'" class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="field.name label">[[ field.name ]]</span>
                        </div>
                        <input type="number" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                            v-model="condition_configuration_fields[index]['value']"
                            :required="condition_configuration_fields[index]['required']">
                    </div>

                </div>
            </span>

            <b-button v-if="condition_selected && update_or_create=='create'" size="sm" class="mt-2" variant="success" 
                @click="addCondition()">Save condition</b-button>
            <b-button v-if="condition_selected && update_or_create=='update'" size="sm" class="mt-2" variant="success" 
                @click="updateCondition()">Save changes</b-button>

        </span>
        
        <!-- Footer -->
        <template v-slot:modal-footer="{ cancel }">
            <b-button size="sm" variant="outline-secondary" @click="cancel()">Done</b-button>
            <!-- TODO: wipe state when this button is clicked -->
        </template>

    </b-modal>

</script>


<script type="application/javascript">


    addRoleComponent = Vue.component('edit-role-modal', {
        delimiters: ['[[', ']]'],
        template: '#edit_role_modal_template',
        data: function() {
            return {
                // general data
                role_to_edit: '',
                edit_role_error_message: '',
                edit_mode: 'permission',  // Edit mode starts on permission
                update_or_create: 'create',  // Edit mode defaults to creating new permission
                // Data for edit role moda - permissions
                permissions: [], // intitially from server, list of dicts, { id, name, display, change_type, configuration }
                permission_options: [],
                permission_selected: '',
                permission_configuration_options: {},
                permission_to_update: '',
                // Data for edit role modal - conditions,
                conditions: {},  // initially from server, { perm.id : { 'name': X, 'config': { }}}
                condition_options: [],
                condition_selected: '',
                condition_configuration_options: {},
                permission_to_condition: '',
                condition_to_update: '',
            }
        },
        methods: {
            
        }
    });

</script>