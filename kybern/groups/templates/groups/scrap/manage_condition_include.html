<script type="text/x-template" id="manage_condition_template">

    <span v-if="mode == 'condition create' || mode == 'condition update'">

        <span v-if="mode == 'condition create'">
            <h5>Select condition to add:</h5>
            <template><div>
                <b-form-select v-model="condition_selected" :options="condition_options" :select-size="4">
                </b-form-select>
            </div></template>
        </span>

        <span v-if="condition_configuration_fields.length > 0">

            <p class="mt-3"><b>Configure your condition</b></p>

            <div class="input-group my-1" v-for="(field, index) in condition_configuration_fields">   

                <div v-if="field.type=='CharField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']" 
                        :required="condition_configuration_fields[index]['required']">
                </div>

                <span v-if="field.type=='BooleanField'">
                    <b-form-checkbox v-model="condition_configuration_fields[index]['value']" 
                        name="checkbox-1" value="true" unchecked-value="false">
                    [[ field.display ]] </b-form-checkbox>
                </span>

                <div v-if="field.type=='IntegerField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="number" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']"
                        :required="condition_configuration_fields[index]['required']">
                </div>
                
                <!-- Should be a choice field populated by current roles -->
                <div v-if="field.type=='PermissionRoleField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']" 
                        :required="condition_configuration_fields[index]['required']">
                </div>

                <!-- Should be a choice field populated by current members -->
                <div v-if="field.type=='PermissionActorField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']" 
                        :required="condition_configuration_fields[index]['required']">
                </div>

            </div>
        </span>

        <b-button v-if="condition_selected && mode == 'condition create'" size="sm" 
            class="mt-3" @click="addCondition()">Save condition</b-button>
        <b-button v-if="condition_to_edit && mode == 'condition update'" size="sm" 
            class="mt-3" @click="updateCondition()">Save changes</b-button>

    </span>

</script>


<script type="application/javascript">

    manageConditionComponent = Vue.component('manage-condition', {
        delimiters: ['[[', ']]'],
        template: '#manage_condition_template',
        props: ['mode', 'condition_to_edit', 'permission_to_condition', 'conditions', 'condition_options', 'condition_configuration_options'],
        data: function() {
            return {
                condition_selected: '',
            }
        },
        computed: {
            condition_configuration_fields: function () {
                // RETURNS: an array of dictionaries, one for each field, with keys: name, type
                // default, required, and value
                if (this.condition_selected || this.condition_to_edit) {
                    if (this.mode == 'condition create') {
                        return this.condition_configuration_options[this.condition_selected]["configuration"]
                    }
                    if (this.mode == 'condition update') {
                        return this.conditions[this.permission_to_condition]['configuration']
                    }
                }
                return []
            }
        },
        methods: {
            addCondition() {
                url = "http://127.0.0.1:8000/groups/add_condition/{{ object.pk}}/";
                params = { condition_type: this.condition_selected, 
                    condition_configuration: JSON.stringify(this.condition_configuration_fields),
                    target_permission_id: this.permission_to_condition }
                implementationCallback = (response) => {
                    Vue.set(this.conditions, this.permission_to_condition, response.data.condition_info)
                    this.condition_selected = '';
                    this.$emit('clear-state', {} )
                }
                this.submit_standard_axios_action_call(url, params, implementationCallback)
            },
            updateCondition() {
                url = "http://127.0.0.1:8000/groups/update_condition/{{ object.pk}}/"
                params = { condition_id : this.condition_to_edit, 
                           permission_id : this.permission_to_condition,
                           condition_configuration : this.condition_configuration_fields}
                implementationCallback = (response) => {
                    this.conditions[this.permission_to_condition]["display"] = response.data.new_display
                    this.condition_selected = ''
                    this.$emit('clear-state', {} )
                }
                this.submit_standard_axios_action_call(url, params, implementationCallback)
            }
        }
    });

</script>