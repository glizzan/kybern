<!-- NOTE: this duplicates a lot of manage_condition_include - we should ideally refactor soon. -->

<script type="text/x-template" id="leadership_condition_template">

    <div v-if="mode == 'condition create' || mode == 'condition update'" class="border m-2 p-2 text-center">


        <span v-if="mode == 'condition create'">
            <span v-if="display_condition_options">
                <b>Select condition to add</b> 
                <template><div>
                    <b-form-select v-model="condition_selected" :options="condition_options" :select-size="4">
                    </b-form-select>
                </div></template> 
            </span>
            <span v-else>
                There is no condition currently set. 
                <b-button variant="outline-secondary" size="sm" class="ml-2" @click="display_condition_options=true">
                    Add one?</b-button>
            </span>
        </span>

        <span v-if="condition_configuration_fields.length > 0">

            <p class="mt-3"><b>Configure your condition</b></p>

            <div class="input-group my-1" v-for="(field, index) in condition_configuration_fields">   

                <div v-if="field.type=='CharField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']" 
                        :required="condition_configuration_fields[index]['required']">
                </div>

                <span v-if="field.type=='BooleanField'">
                    <b-form-checkbox v-model="condition_configuration_fields[index]['value']" 
                        name="checkbox-1" value="true" unchecked-value="false">
                    [[ field.display ]] </b-form-checkbox>
                </span>

                <div v-if="field.type=='IntegerField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="number" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']"
                        :required="condition_configuration_fields[index]['required']">
                </div>
                
                <!-- Should be a choice field populated by current roles -->
                <div v-if="field.type=='PermissionRoleField'" class="input-group mb-3 w-50">
                     <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']" 
                        :required="condition_configuration_fields[index]['required']">
                </div>

                <!-- Should be a choice field populated by current members -->
                <div v-if="field.type=='PermissionActorField'" class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="field.name label">[[ field.display ]]</span>
                    </div>
                    <input type="text" class="form-control" aria-label="field.name" aria-describedby="field.name label" 
                        v-model="condition_configuration_fields[index]['value']" 
                        :required="condition_configuration_fields[index]['required']">
                </div>

            </div>
        </span>

        <b-button v-if="condition_selected && mode == 'condition create'" size="sm" 
            class="mt-3" @click="addCondition()">Save condition</b-button>
        <b-button v-if="condition_data && mode == 'condition update'" size="sm" 
            class="mt-3" @click="updateCondition()">Save changes</b-button>

    </div>
</script>


<script type="application/javascript">

    leadershipConditionComponent = Vue.component('leadership-condition', {
        delimiters: ['[[', ']]'],
        template: '#leadership_condition_template',
        props: ['mode', 'called_for', 'condition_data', 'conditions', 'condition_options', 'condition_configuration_options'],
        data: function() {
            return {
                condition_selected: '',
                display_condition_options: false,
            }
        },
        computed: {
            condition_configuration_fields: function () {
                if (this.condition_data && this.mode == "condition update") { return this.condition_data }
                if (this.condition_selected && this.mode == "condition create") { 
                    return this.condition_configuration_options[this.condition_selected]["configuration"] 
                }
                return []
            }
        },
        methods: {
            addCondition() {
                url = "http://127.0.0.1:8000/groups/add_leadership_condition/{{ object.pk}}/";
                params = { called_for: this.called_for, condition_type: this.condition_selected,
                    condition_configuration: JSON.stringify(this.condition_configuration_fields)}
                implementationCallback = (response) => {
                    Vue.set(this.conditions, response.data.condition_info.id, response.data.condition_info)
                    this.condition_selected = '';
                }
                this.submit_standard_axios_action_call(url, params, implementationCallback)
            },
            updateCondition() {
                // Fix so it's updating leadership condition (own v gov with 'called_for')

                console.log("Time to replace update condition")

                // url = "http://127.0.0.1:8000/groups/update_condition/{{ object.pk}}/"
                // params = { condition_id : this.condition_to_edit, 
                //            permission_id : this.permission_to_condition,
                //            condition_configuration : this.condition_configuration_fields}
                // implementationCallback = (response) => {
                //     this.conditions[this.permission_to_condition]["display"] = response.data.new_display_name
                //     this.condition_selected = ''
                //     this.$emit('clear-state', {} )
                // }
                // this.submit_standard_axios_action_call(url, params, implementationCallback)
            }
        }
    });

</script>