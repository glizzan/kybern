<script type="text/x-template" id="manage_permission_template">
    <div class="border m-2 p-2 text-center"> 

        <!-- Before anyone has indicated they want add or edit a permission, just display a button. -->
        <b-button v-if="mode == 'start'" v-on:click="switch_to_create_mode()" class="btn-sm my-3">Add a permission</b-button>   

        <!-- If we're creating a new permission -->
        <span v-if="mode == 'create' && !permission_selected ">
                <b>Select permission to add</b> 
                <template><div>
                    <b-form-select v-model="permission_selected" :options="permission_options" :select-size="4">
                    </b-form-select>
                </div></template>
        </span>

        <!-- If we're updating an existing permission (or configuring a new permission that has been selected) -->
        <span v-if="mode == 'update' || permission_selected">

            <!-- If we've got fields to configure, or this is a permission for an item so we need to set actors and/or roles -->
            <span v-if="configuration_fields.length > 0 || !this.role_to_edit ">

                <p class="mt-3"><b>Configure your permission</b></p>

                <span v-if="!role_to_edit">
                    {% include 'groups/role_and_actor_fields_include.html' %}
                </span>

                {% include 'groups/configuration_fields_include.html' %}

            </span>


            <b-button v-if="permission_selected && mode =='create'" size="sm" 
                class="mt-3" @click="add_permission()">Save new permission</b-button>
            <b-button v-if="permission_to_edit && mode == 'update'" size="sm" 
                class="mt-3" @click="update_permission()">Save changes to permission</b-button>

        </span>

        <div class="mb-3 text-danger" v-if="error_message">
            [[ error_message ]]
        </div>

    </div>
</script>


<script type="application/javascript">

    managePermissionComponent = Vue.component('manage-permission', {
        delimiters: ['[[', ']]'],
        template: '#manage_permission_template',
        props: ['mode_from_parent', 'role_to_edit', 'permission_to_edit', 'item_id', 'item_model'],
        store,
        data: function() {
            return {
                permission_selected: '',
                mode: 'start',
                configuration_fields: [],
                error_message: '',
                // only used for permission field on item (not on roles)
                permission_roles_selected: [],
                permission_actors_selected: []
            }
        },
        watch: {
            mode_from_parent: function (val) {
                // The parent of the condition include can change the mode - overrides current mode (on change, not permanently)
                this.mode = val; 
            },
            permission_to_edit: function (val) {
                if (this.permission_to_edit) {
                    this.configuration_fields = Object.values(this.getPermissionConfigurationFieldsWithData(this.permission_to_edit))
                
                    if (this.item_id && this.item_model) { // only do this for permission on item
                        role_list = this.permissions[this.permission_to_edit].roles
                        actor_list = this.permissions[this.permission_to_edit].actors
                        this.permission_roles_selected = this.role_to_options(role_list)
                        this.permission_actors_selected = this.user_pk_to_options(actor_list) 
                    }
                }
            },
            permission_selected: function (val) {
                if (this.permission_selected) {
                    this.configuration_fields = Object.values(this.getPermissionConfigurationFields(this.permission_selected))
                }
            }
        },
        computed: {
            ...Vuex.mapState(['permission_options', 'permissions']),
            ...Vuex.mapGetters(['rolesAsOptions', 'groupMembersAsOptions', 'getPermissionConfigurationFields', 
                'getPermissionConfigurationFieldsWithData', 'select_field_is_multiple', 'role_to_options',
                'user_pk_to_options'])
        },
        methods: {
            ...Vuex.mapActions(['addPermission', 'updatePermission', 'addPermissionToItem']),
            switch_to_create_mode() {
                // helper function to reset necessary state
                this.$emit("clearState");
                this.mode = 'create'
                this.permission_selected = ''
                this.configuration_fields = []
            },
            add_permission() {
                if (this.role_to_edit) {
                    this.addPermission({ permission_selected : this.permission_selected, role : [this.role_to_edit],
                    configuration : this.configuration_fields })
                    .then(response => { this.permission_selected = ''; this.$emit("clearState"); })
                    .catch(error => {  this.error_message = error })
                } else if (this.item_id && this.item_model) {
                    // TODO: this should be configured so it's on the specific item
                    this.addPermissionToItem({ pk: this.item_id, model: this.item_model,
                        permission_selected : this.permission_selected, configuration : this.configuration_fields,
                        roles: this.permission_roles_selected, actors: this.permission_actors_selected })
                    .then(response => { this.permission_selected = ''; this.permission_actors = [],
                        this.permission_roles = []; this.$emit("clearState"); })
                    .catch(error => {  this.error_message = error })
                }
            },
            update_permission() {
                this.updatePermission({ permission_id: this.permission_to_edit, configuration : this.configuration_fields })
                .then(response => { this.$emit("clearState"); })
                .catch(error => {  this.error_message = error })
            }
        }
    });

</script>