<script type="text/x-template" id="vote_condition_template">
    <span>

        <!-- Information about the vote. -->
        <span v-if="is_resolved">
            This vote, on [[ action_display ]], ended on [[ voting_deadline ]]. The results were [[ vote_results ]].
            It required a [[ majority_or_plurality ]] vote and abstentions were <span v-if="!allow_abstain">not</span> 
            allowed.
        </span>

        <span v-else>
            This vote, on [[ action_display ]], will end on [[ voting_deadline ]]. The results so far are 
            [[ vote_results ]]. It requires a [[ majority_or_plurality ]] vote and abstentions are 
            <span v-if="!allow_abstain">not</span> allowed.
        </span> 


        <!-- If action is waiting, and user has not taken action -->
        <span v-if="!is_resolved && !user_has_taken_action" class="my-5">

            <!-- If user can vote -->
            <span v-if="can_vote && not_yet_voted">

                    <p class="mb-3"><b>Please cast your vote</b></p>
                    <b-form-radio-group id="btn-radios-1" v-model="button_selected" :options="button_options"
                        buttons name="radios-btn-default" button-variant="outline-primary">
                    </b-form-radio-group>
                    <b-button @click="update_condition">Submit</b-button>
            
            </span>

            <span v-else-if="can_vote && !not_yet_voted">
                <p class="mb-3"><b>You have already voted.</b></p>
            </span>

            <span v-else>
                <p class="mb-3"><b>You are not eligible to vote.</b></p>
            </span>

        </span>

        <!-- If user has just voted.-->
        <span v-if="user_has_taken_action">
            Thank you for voting!  No further action from you is needed.
        </span>

        <span v-if="error_message" class="text-danger">[[ error_message ]]</span> 

</span>
</script>


<script type="application/javascript"> 

// I want, when the condition is initialized (when conditiontype is set to votecondition?), to initialize all the
// configuration stuff so they can be referenced in the template and then forgotten about


voteConditionComponent = Vue.component('vote-condition-ui', {
    delimiters: ['[[', ']]'],
    template: '#vote_condition_template',
    props: ['condition_type', 'condition_data'],
    data: function() {
        return {
            user_has_taken_action: false,
            button_selected: null,
            error_message: null,
            // Helper variables made when condition_type matches
            action_display: null,
            majority_or_plurality: null,
            voting_deadline: null,
            allow_abstain: null,
            vote_results: null,
            is_resolved: null,
            button_options: [],
            can_vote: null,
            not_yet_voted: null,
            condition_status: null
        }
    },
    mounted: function () { this.refresh_condition_data_helpers() },
    methods: {
        get_condition_field_value(field_name) {
            for (index in this.condition_data.condition_details.fields) {
                if (this.condition_data.condition_details.fields[index]["field_name"] == field_name) {
                    return this.condition_data.condition_details.fields[index]["field_value"]
                }
            }
        },
        refresh_condition_data_helpers() {
            // condition status
            this.condition_status = this.condition_data.condition_details.status
            // action_display
            this.action_display = this.condition_data.action_details.description
            // require_majority
            if  (this.get_condition_field_value("require_majority")) {
                this.majority_or_plurality = "majority"
            } else {
                this.majority_or_plurality = "plurality"
            }
            // voting_deadline
            this.voting_deadline = this.get_condition_field_value("voting_deadline")
            // allow_abstain
            this.allow_abstain = this.get_condition_field_value("allow_abstain")
            // vote_results
            this.vote_results = this.get_condition_field_value("current_yeas") + " yeas and " +
                                                this.get_condition_field_value("current_nays") + " nays"
            if (this.allow_abstain) {
                this.vote_results += " with " + this.get_condition_field_value("current_abstains") + " abstentions"
            }
            // is_resolved
            if (["approved", "rejected", "implemented"].includes(this.condition_status)) { this.is_resolved = true }                
            else { this.is_resolved = false }
            // button_options
            if (this.allow_abstain) { this.button_options = ["yea", "nay", "abstain"] } 
            else { this.button_options =  ["yea", "nay"] }
            this.button_options
            // can_vote
            this.can_vote = this.condition_data.permission_details["concord.conditionals.state_changes.AddVoteStateChange"][0]
            // already voted
            this.not_yet_voted = this.condition_data.permission_details["user_condition_status"][0]
        },
    
        update_condition() {
            url = "http://127.0.0.1:8000/groups/update_vote_condition/{{ target.pk}}/"
            params = { 
                condition_pk: this.condition_data.condition_pk,
                action_to_take: this.button_selected
            }
            implementationCallback = () => {    // using an arrow function here to pass surrounding context's this
                // Call get_condition_data method to get updated condition data & adjust local vars
                this.get_condition_data(this.condition_data.condition_pk, this.condition_type)
                .then(response=> {

                    // Update with new data
                    this.condition_data.permission_details = response.data.permission_details
                    this.condition_data.condition_details = response.data.condition_details
                    this.refresh_condition_data_helpers()

                    // If condition status has changed to a 'resolved' state, emit notification.
                    if (this.condition_status == "approved" || this.condition_status == "rejected" ) {
                        EventBus.$emit('action-changed', this.condition_data.action_pk );
                    }  
                })
                this.user_has_taken_action = true
            }
            this.submit_standard_axios_action_call(url, params, implementationCallback)
        }
    }
})

</script>
