<script type="text/x-template" id="simplelist_component_template">

    <span>

        <h3 class="mt-3">[[ list_name ]]</h3>
        <p>[[ list_description ]]</p>

        <router-link v-if="user_permissions.edit_list"
                :to="{ name: 'edit-list-info', params: { list_id: list_id } }">
            <b-button variant="outline-secondary" class="btn-sm" id="edit_list_button">
                edit list info</b-button>
        </router-link>

        <b-button v-if="user_permissions.delete_list" variant="outline-secondary" class="btn-sm" 
            id="delete_list_button" @click="delete_list(list_id)">delete list</b-button>

        <router-link :to="{ name: 'list-action-history', 
            params: {list_id: list_id, item_id: list_id, item_model: 'simplelist', item_name: list_name }}">
                <b-button variant="outline-secondary" class="btn-sm"" id="list_history_button">
                    list history</b-button>
        </router-link>

        <router-link :to="{ name: 'item-permissions', params: {item_id: list_id, item_model: 'simplelist', item_name: list_name }}">
                <b-button variant="outline-secondary" id="list_permissions" class="btn-sm"">
                    list permissions</b-button>
        </router-link>

        <router-link v-if="user_permissions.add_row"
                    :to="{ name: 'add-list-row', params: { list_id: list_id, mode: 'create' } }">
                <b-button variant="outline-info" class="btn-sm" id="add_row_button">
                    add a row</b-button>
        </router-link>


        <error-component :message="error_message"></error-component>

        <hr >

        <b-table striped hover :items="list_data" :fields="list_fields">

                <template v-slot:cell(change)="data">

                    <router-link v-if="user_permissions.edit_row" :to="{ name: 'edit-list-row', 
                        params: { list_id: list_id, mode: 'edit', row_index: data.item.index } }"
                        :id="'edit_row_' + data.item.index">
                        <b-button variant="outline-secondary" class="btn-sm">edit</b-button>
                    </router-link>
                    
                    <b-button v-if="user_permissions.delete_row" variant="outline-secondary" 
                        class="btn-sm" @click="delete_row(data.item)" :id="'delete_row_' + data.item.index">
                    delete</b-button>

                </template>

        </b-table>

        <span v-if="Object.keys(rows).length === 0">There are no items yet in this list.</span>

    </span>

</script>

<script type="application/javascript"> 

    listComponent = Vue.component('list-component', {
        delimiters: ['[[', ']]'],
        template: '#simplelist_component_template',
        props: ['list_id'],
        store,
        mixins: [utilityMixin],
        data: function() {
                return {
                    error_message: null
                }
            },
        created (){ 
            if (!this.lists_loaded) {  this.getLists()  }
            alt_target = "simplelist_" + this.list_id
            this.checkPermissions({
                permissions: 
                    { edit_list: {alt_target : alt_target}, 
                      delete_list: {alt_target : alt_target}, 
                      add_row: {alt_target : alt_target},
                      edit_row: {alt_target : alt_target},
                      delete_row: {alt_target : alt_target}}
            }).catch(error => {  this.error_message = error; console.log(error) })
        },
        computed: {
            ...Vuex.mapState({
                lists: state => state.simplelists.lists,
                user_permissions: state => state.permissions.current_user_permissions
            }),
            ...Vuex.mapGetters(['getListData', 'getUserName']),
            lists_loaded: function() { if (this.lists.length == 0) { return false } else { return true }},
            rows: function() {
                if (this.lists_loaded) { return this.getListData(this.list_id).rows } else { return [] }},
            configuration: function() {
                if (this.lists_loaded) { return this.getListData(this.list_id).configuration } else { return {} }},
            list_name: function() {
                if (this.lists_loaded) { return this.getListData(this.list_id).name } else { return "" }},
            list_description: function() {
                if (this.lists_loaded) { return this.getListData(this.list_id).description } 
                else { return }},
            list_fields: function() {
                list_fields = [{ key: 'index', sortable: true }]
                if (this.lists_loaded) {
                    for (field in this.configuration) {
                        list_fields.push({key: field, sortable: true})
                    }
                }
                list_fields.push('change')
                return list_fields
            },
            list_data: function() {
                list_data = []
                index = 0
                for (row in this.rows) {
                    row_dict = {}
                    for (field in this.rows[row]) {
                        row_dict[field] = this.rows[row][field]
                    }
                    row_dict["index"] = index
                    list_data.push(row_dict)
                    index++
                }
                return list_data
            }
        },
        methods: {
            ...Vuex.mapActions(['checkPermissions', 'getLists', 'deleteList', 'deleteRow']),
            display_date(date) { return Date(date) },
            delete_list(list_id) {
                this.deleteList({list_pk: list_id})
                .then(response => { this.$router.push({name: 'home'}) })
                .catch(error => {  this.error_message = error })
            },
            delete_row(item) {
                this.deleteRow({list_pk: this.list_id, index:item.index})
                .catch(error => {  this.error_message = error })
            }
        }
    })
    
    
    </script>