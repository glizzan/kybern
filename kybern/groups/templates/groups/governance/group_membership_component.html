<script type="text/x-template" id="group_membership_template">

    <span>
        <b-card header="Members" class="my-3">

            <div class="text-center d-flex">

            <b-button class="mx-2 flex-fill" v-b-modal.group_membership_settings_modal id="group_membership_settings_button">
                how membership works</b-button>

            <b-button class="mx-2 flex-fill" v-b-modal.group_membership_display id="group_membership_display_button">
                view & change members</b-button>

            <b-button class="mx-2 flex-fill" v-if="user_permissions.join_group" id="join_group_button"
                @click="join_group()">join group</b-button>
                
            <b-button class="mx-2 flex-fill" v-if="user_permissions.leave_group" id="leave_group_button"
                @click="leave_group()">leave group</b-button> 
                
            </div>
                                      
        </b-card>

        <b-modal id="group_membership_settings_modal" title="Group Membership Settings" class="modal fade"
                size="lg" hide-footer>

            <error-component :message=error_message></error-component>

            <span id="add_member_permissions">
                <p class="pb-1 font-weight-bold">Permissions for Adding Members</p>
                <edit-permission v-for="permission in addmember_permissions" v-bind:key="permission.pk"
                    :permission=permission :item_id=item_id :item_model=item_model> </edit-permission>            
                <p v-if="!addmember_permissions.length">No permissions for adding members have been 
                    set yet. This means only people with foundational or governing permission can 
                    add members.</p>
                <add-permission :default_selection=add_member_state_change :item_id=item_id 
                    :item_model=item_model> </add-permission>
            </span> 

            <span id="remove_member_permissions">
                <p class="pt-4 pb-1 font-weight-bold">Permissions for Removing Members</p>
                <edit-permission v-for="permission in removemember_permissions" v-bind:key="permission.pk" 
                    :permission=permission :item_id=item_id :item_model=item_model> </edit-permission>
                <p v-if="!removemember_permissions.length">No permissions for removing members have 
                    been set yet. This means only people with foundational or governing permission can 
                    remove members.</p>
                <add-permission :default_selection=remove_member_state_change :item_id=item_id 
                    :item_model=item_model></add-permission>
            </span>

            <template-manager :scope=template_scope></template-manager>

        </b-modal>


        <b-modal id="group_membership_display" title="Group Membership" class="modal fade" size="lg" hide-footer>

            <error-component :message=error_message></error-component>

            <b>Current Members:</b>
                <span id="current_member_list"> <b-badge v-for="member in groupMembersAsOptions" v-bind:key="member.pk" 
                pill variant="info" class="mx-1">[[ member.name ]]</b-badge></span>

            <hr >

            <span v-if="user_permissions.add_members">

                <span v-if="add_member_button_selected">
                    <vue-multiselect v-model="members_to_add_selected" :options="nonmembersAsOptions" :multiple="true" 
                        :close-on-select="true" :clear-on-select="false" placeholder="No one selected" 
                        label="name" track-by="name">
                        <template slot="selection" slot-scope="{ values, search, isOpen }">
                            <span v-if="!isOpen"> Selected: [[ values ]] </span>
                        </template>
                    </vue-multiselect>
                    <b-button class="btn-sm mb-3" id="save_add_member_button" @click="add_members()">Save</b-button>
                    <b-button class="btn-sm mb-3" @click="add_member_button_selected = false">Discard</b-button>
                </span>
                <span v-else>
                    <span v-if="!remove_member_button_selected">
                        <b-button class="btn-sm mb-3" id="add_member_button"
                            @click="add_member_button_selected = true">Add Members</b-button>
                    </span>
                </span>

            </span>

            <span v-if="user_permissions.remove_members">

                <span v-if="remove_member_button_selected">
                    <vue-multiselect v-model="members_to_remove_selected" :options="groupMembersAsOptions" :multiple="true" 
                        :close-on-select="true" :clear-on-select="false" placeholder="No one selected" 
                        label="name" track-by="name">
                        <template slot="selection" slot-scope="{ values, search, isOpen }">
                            <span v-if="!isOpen"> Selected: [[ values ]] </span>
                        </template>
                    </vue-multiselect>
                    <b-button class="btn-sm mb-3" id="save_remove_member_button" @click="remove_members()">Save</b-button>
                    <b-button class="btn-sm mb-3" @click="remove_member_button_selected = false">Discard</b-button>
                </span>
                <span v-else>
                    <span v-if="!add_member_button_selected">
                        <b-button class="btn-sm mb-3" id="remove_member_button"
                            @click="remove_member_button_selected = true">Remove Members</b-button> 
                    </span>
                </span>

            </span>

        </b-modal>

    </span>
    
</script>

<script type="application/javascript">

    groupMembershipComponent = Vue.component('group-membership-component', {
        delimiters: ['[[', ']]'],
        template: '#group_membership_template',
        store,
        data: function() {
            return {   
                template_scope: 'membership',
                user_pk: {{ request.user.pk }},
                item_id: {{ object.pk }},  // Group id,
                item_model: 'group',  // group model
                add_member_state_change: 'concord.communities.state_changes.AddMembersStateChange',
                remove_member_state_change: 'concord.communities.state_changes.RemoveMembersStateChange',
                add_member_button_selected: false,
                remove_member_button_selected: false,
                members_to_add_selected: [],
                members_to_remove_selected: [],
                error_message: null
            }
        },
        created () {
            this.checkPermissions({permissions: 
                {"add_members": null, "remove_members": null, "join_group": null, "leave_group": null}})
                .catch(error => {  this.error_message = error; console.log(error) })
            this.getPermissionsForItem({ item_id: this.item_id, item_model: this.item_model })
                .catch(error => {  this.error_message = error; console.log(error) })
        },
        computed: {
            ...Vuex.mapState({ 
                permissions: state => state.permissions.permissions,
                user_permissions: state => state.permissions.current_user_permissions
            }),
            ...Vuex.mapGetters(['groupMembersAsOptions', 'nonmembersAsOptions']),
            addmember_permissions() {
                return Object.values(this.permissions).filter(permission => 
                    permission.change_type == this.add_member_state_change)
            },
            removemember_permissions() {
                return Object.values(this.permissions).filter(permission => 
                    permission.change_type == this.remove_member_state_change)
            }
        },
        methods: {
            ...Vuex.mapActions(['getPermissionsForItem', 'checkPermissions', 'addMembers', 'removeMembers']),
            join_group() {
                this.addMembers({ user_pks: [this.user_pk] }).then(response => window.location.reload())
                    .catch(error => console.log(error))
            },
            leave_group() {
                this.removeMembers({ user_pks: [this.user_pk] }).then(response => window.location.reload())
                    .catch(error => console.log(error))
            },
            add_members() {
                members_to_add = this.members_to_add_selected.map(actor => actor.pk)
                this.addMembers({ user_pks: members_to_add }).catch(error => this.error_message = error)
            },
            remove_members() {
                members_to_remove = this.members_to_remove_selected.map(actor => actor.pk)
                this.removeMembers({ user_pks: members_to_remove }).catch(error => this.error_message = error)
            }
        }
    });

</script>
