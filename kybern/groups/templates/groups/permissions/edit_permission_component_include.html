<script type="text/x-template" id="edit_permission_component_template">

    <span>

        <span v-if="error_message" class="text-danger">[[ error_message ]]</span>

        <!-- Display existing permission -->
        
        <span :id=pair_element_id><div class="btn-group" role="group">
            <b-button variant="light">
                <small class="permission-display">[[ permission.display ]]</small>
                <span v-on:click="edit_permission_mode=true" class="badge badge-light ml-1"  >ðŸ–‰</span>
                <span v-on:click="delete_permission()" class="badge badge-light ml-1"  >ðŸ—‘</span>
            </b-button>
            <b-button v-if="permission.condition" variant="secondary">
                <small>on the condition that [[ permission.condition.how_to_pass ]]</small>
                <span v-on:click="edit_condition_mode='update'" class="badge badge-secondary ml-1">ðŸ–‰</span>
                <span v-on:click="delete_condition()" class="badge badge-secondary ml-1"  >ðŸ—‘</span>
            </b-button>
            <b-button v-else v-on:click="edit_condition_mode='create'" variant="secondary">
                <small>add condition</small></b-button>
        </div></span>

        <span v-if="edit_permission_mode">
            
            <!-- If a role was not passed in, that means we need to ask the user for what roles and
            actors should be given this permission. -->
            <span v-if="!role_to_edit" class="mb-3">
                <p class="mt-3 font-weight-bold">Give people this permission</p>
                {% include 'groups/permissions/role_and_actor_fields_include.html' %}
            </span>
    
            <!-- If there are fields to configure -->
            <span v-if="configuration_fields.length > 0" class="mb-3">
                <p class="mt-3 font-weight-bold">Configure your permission</p>
                {% include 'groups/permissions/configuration_fields_include.html' %}
            </span>
    
            <b-button size="sm" class="mt-3" @click="update_permission()" id="update_permission_button">                    
                Update permission</b-button>

            <b-button size="sm" class="mt-3" @click="clearState()" id="discard_permission_button">
                Discard changes</b-button>

        </span>

        <span v-if="edit_condition_mode"></span>
            <permission-condition :permission=permission :mode_from_parent=edit_condition_mode>
            </permission-condition>             
        </span>

    </span>

</script>

<script type="application/javascript">

    editPermissionComponent = Vue.component('edit-permission', {
        delimiters: ['[[', ']]'],
        template: '#edit_permission_component_template',
        props: ['permission', 'role_to_edit', 'item_id', 'item_model'],
        store,
        data: function() {
            return {
                permission_exists: true,
                edit_permission_mode: null,
                edit_condition_mode: null,
                configuration_fields: [],
                error_message: '',
                permission_roles_selected: [],
                permission_actors_selected: []
            }
        },
        watch: {
            permission: function(val) {
                if (val) {
                    this.configuration_fields = Object.values(
                        this.getPermissionConfigurationFieldsWithData(val.pk))               
                    if (this.item_id && this.item_model) { // only do this for permission on item
                        this.permission_roles_selected = this.role_to_options(val.roles)
                        this.permission_actors_selected = this.user_pk_to_options(val.actors) 
                    }
                }
            }
        },
        computed: {
            ...Vuex.mapState({ permissions: state => state.permissions.permissions }),
            ...Vuex.mapGetters(['rolesAsOptions', 'groupMembersAsOptions', 'getPermissionConfigurationFields', 
                'select_field_is_multiple', 'role_to_options', 'user_pk_to_options']),
            anyone_can_take_permission() { return this.permission.anyone },
            item_or_role() { 
                console.log(this.role_to_edit, this.item_id, this.item_model)
                if (this.role_to_edit) { return "role"} 
                else if (this.item_id && this.item_model) { return "item" }
            },
            pair_element_id() {
                return "permission_element_" + permission.pk
            }
        },
        methods: {
            ...Vuex.mapActions(['removePermission', 'updatePermission', 'removeCondition']),
            get_roles() {
                if (this.item_or_role == "role") { return [this.role_to_edit] }
                else if (this.item_or_role == "item") { return this.permission_roles_selected }
            },
            clearState() { 
                this.edit_permission_mode = null
                this.edit_condition_mode = null
                this.configuration_fields = []
                this.permission_roles_selected = []
                this.permission_actors_selected = []
            },
            // Vuex actions
            delete_permission() {
                this.removePermission({ permission_id : this.permission.pk, item_id: this.item_id,
                        item_model: this.item_model, item_or_role : this.item_or_role })
                .then(response => { this.clearState() })
                .catch(error => {  this.error_message = error.message  })               
            },
            update_permission() {
                this.updatePermission({ item_or_role: this.item_or_role, item_id : this.item_id, 
                    item_model: this.item_model, permission_id: this.permission.pk, 
                    configuration : this.configuration_fields, roles: this.get_roles(),
                    actors: this.permission_actors_selected
                }).then(response => { this.clearState() })
                .catch(error => {  this.error_message = error })
            },
            delete_condition() {
                this.removeCondition({ permission_or_leadership: "permission",
                                                permission_id: this.permission.pk })
                .catch(error => { this.error_message = error.message })
            },
            toggle_anyone(enable_or_disable) {
                this.toggleAnyone({ permission_id: this.permission.pk, 
                                                enable_or_disable: enable_or_disable })
                .catch(error => {  this.error_message = error })
            }
        }
    });

</script>