<script type="text/x-template" id="add_permission_component_template">

    <span>

        <error-component :message=error_message></error-component>

        <span v-if="!add_permission_button_clicked">

            <b-button v-if="user_permissions.add_permission" size="sm" v-on:click="add_permission_button_clicked=true"
                variant="outline-dark" class="my-2" id="add_permission_button">Add Permission</b-button>

        </span>

        <div v-if="add_permission_button_clicked">

            <div v-if="!permission_selected" class="my-3">

                <b>Select permission to add</b>
                <vue-multiselect v-model="permission_selected" :options="permission_options_to_use" :allow-empty="true"
                :close-on-select="true" placeholder="Select permission" label="text" track-by="value" :max-height="200"
                name="permission_select" group-values="permissions" group-label="section">
                    <template slot="selection" slot-scope="{ values, search, isOpen }">
                        <span v-if="!isOpen">
                            Selected: [[ values ]]
                        </span>
                    </template>
                </vue-multiselect>

            </div>

            <div v-else>

                <!-- If a role was not passed in, that means we need to ask the user for what roles and
                    actors should be given this permission. -->
                <span v-if="!role_to_edit" class="mb-3">
                    <p class="mt-3 font-weight-bold">Give people this permission</p>
                    {% include 'groups/permissions/role_and_actor_fields_include.html' %}
                </span>

                <!-- If there are fields to configure -->
                <span v-if="configuration_fields.length > 0" class="mb-3">
                    <p class="mt-3 font-weight-bold">Configure your permission</p>
                    {% include 'groups/permissions/configuration_fields_include.html' %}
                </span>

                <b-button size="sm" class="mt-3" @click="add_permission()" id="save_permission_button">
                    Save permission</b-button>

                <b-button size="sm" class="mt-3" @click="clearState()" id="discard_permission_button">
                    Discard</b-button>

            </div>

        </div>

    </span>

</script>

<script type="application/javascript">

    addPermissionComponent = Vue.component('add-permission', {
        delimiters: ['[[', ']]'],
        template: '#add_permission_component_template',
        props: ['default_selection', 'role_to_edit', 'item_id', 'item_model'],  // item_model is required
        store,
        data: function() {
            return {
                permission_exists: false,
                add_permission_button_clicked: false,
                permission_selected: '',
                configuration_fields: [],
                error_message: '',
                permission_roles_selected: [],
                permission_actors_selected: [],
                anyone_can_take_permission: false
            }
        },
        created () {
            if (this.default_selection) {
                this.permission_selected = this.get_full_selection(this.default_selection)
            }
            alt_target = this.item_model + "_" + this.item_id
            this.checkPermissions({permissions: {add_permission: {alt_target:alt_target}}})
            .catch(error => {  this.error_message = error; console.log(error) })
        },
        watch: {
            default_selection: function (val) {
                return this.get_full_selection(val)
            },
            permission_selected: function (val) {
                if (this.permission_selected) {
                    this.configuration_fields = Object.values(this.getPermissionConfigurationFields(this.permission_selected.value))
                }
            }
        },
        computed: {
            ...Vuex.mapState({
                permissions: state => state.permissions.permissions,
                permission_options: state => state.permissions.permission_options,
                user_permissions: state => state.permissions.current_user_permissions
                }),
            ...Vuex.mapGetters(['rolesAsOptions', 'groupMembersAsOptions', 'getPermissionConfigurationFields',
                'select_field_is_multiple', 'role_to_options', 'user_pk_to_options']),
            item_or_role() {
                if (this.role_to_edit) { return "role"}
                else if (this.item_id && this.item_model) { return "item" }
            },
            item_permission_options() {
                return this.permission_options[this.item_model]
            },
            permission_options_to_use() {
                if (this.role_to_edit) {
                    let options = new Map()
                    for (var permissioned_object_model in this.permission_options) {
                        this.permission_options[permissioned_object_model].forEach(option => {
                            if (!options.has(option.value)) { options.set(option.value, option) }
                        })
                    }
                    return this.create_permission_groups(Array.from(options.values()))
                }
                else { return this.create_permission_groups(this.item_permission_options) }
            }
        },
        methods: {
            ...Vuex.mapActions(['checkPermissions', 'addPermission']),
            clearState() {
                if (!this.default_selection) { this.permission_selected = '' }
                this.add_permission_button_clicked = false
                this.permission_actors_selected = []
                this.permission_roles_selected = []
                this.configuration_fields = []
            },
            get_full_selection(value) {
                for (group_index in this.permission_options_to_use) {
                    for (permission_index in this.permission_options_to_use[group_index].permissions) {
                        if (this.permission_options_to_use[group_index].permissions[permission_index].value == value) {
                            return this.permission_options_to_use[group_index].permissions[permission_index]
                        }}}
            },
            create_permission_groups(permission_options) {
                new_options = {}
                for (index in permission_options) {
                    option = permission_options[index]
                    if (option.group in new_options) {
                        new_options[option.group].push(option)
                    } else {
                        new_options[option.group] = [option]
                    }
                }
                grouped_options = []
                for (group in new_options) {
                    if (["Leadership", "Community", "Permissions", "Miscellaneous"].indexOf(group) > -1) {
                        grouped_options.push({section: group, permissions: new_options[group]})
                    } else {
                        grouped_options.unshift({section: group, permissions: new_options[group]})
                    }
                }
                return grouped_options
            },
            get_roles() {
                if (this.item_or_role == "role") { return [this.role_to_edit] }
                else if (this.item_or_role == "item") { return this.permission_roles_selected }
            },
            add_permission() {
                this.addPermission({ item_or_role : this.item_or_role, item_id : this.item_id, item_model: this.item_model,
                    permission_selected : this.permission_selected.value, configuration : this.configuration_fields,
                    roles: this.get_roles(), actors: this.permission_actors_selected, anyone: this.anyone
                }).then(response => { this.clearState()
                }).catch(error => {  this.error_message = error })
            },
            toggle_anyone(enable_or_disable) {
                if (enable_or_disable == "enable") { this.anyone_can_take_permission = true }
                else { this.anyone_can_take_permission = false }
            }
        }
    });

</script>


