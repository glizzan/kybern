<script type="text/x-template" id="condition_template">

    <div class="border m-2 p-2 text-center"> 

        <!-- Before anyone has indicated they want add or edit a condition -->
        <span v-if="mode == 'start'">

            <!-- Condition details/management are usually hidden by default on permissions, shown by default on community -->
            <span v-if="called_for == 'owner' || called_for == 'governor'">   

                    <span v-if="condition_to_edit">
                        [[ condition_display_helper ]]
                        <b-button variant="outline-secondary" size="sm" class="ml-2" @click="mode = 'update'">
                            Edit</b-button>
                        <b-button variant="outline-secondary" size="sm" class="ml-2" @click="remove_condition()">
                            Remove</b-button>
                    </span>
                    <span v-else>
                        There is no condition currently set. 
                        <b-button variant="outline-secondary" size="sm" class="ml-2" @click="mode = 'create'">
                            Add one?</b-button>
                    </span>

            </span>

        </span>

        <!-- If we're creating a new condition -->
        <span v-if="mode == 'create' && !condition_selected ">
            <b>Select condition to add</b> 
                <template><div>
                    <b-form-select v-model="condition_selected" :options="condition_options" :select-size="4">
                    </b-form-select>
                </div></template> 
            </span>
        </span>

        <!-- If we're updating an existing condition (or configuring a new condition that has been selected) -->
        <span v-if="mode == 'update' || condition_selected">

                <p class="mt-3"><b>Configure your condition</b></p>
                {% include 'groups/configuration_fields_include.html' %}

            <!-- Save configuration -->
            <b-button v-if="condition_selected && mode == 'create'" size="sm" 
            class="mt-3" @click="add_condition()">Save condition</b-button>
            <b-button v-if="condition_to_edit && mode == 'update'" size="sm" 
                class="mt-3" @click="update_condition()">Save changes</b-button>

        </span>

        <div class="mb-3 text-danger" v-if="error_message">
            [[ error_message ]]
        </div>

    </div>

</script>

<script type="application/javascript">

    conditionComponent = Vue.component('manage-condition', {
        delimiters: ['[[', ']]'],
        template: '#condition_template',
        store, 
        props: ['mode_from_parent', 'called_for', 'permission_to_condition', 'condition_to_edit'],
        data: function() {
            return {
                condition_selected: '',
                mode: 'start',
                configuration_fields: [],
                error_message : ''
            }
        },
        watch: {
            mode_from_parent: function (val) {
                // The parent of the condition include can change the mode - overrides current mode (on change, not permanently)
                this.mode = val; 
            },
            condition_to_edit: function (val) {
                if (this.condition_to_edit) {
                    this.configuration_fields = Object.values(this.getConditionConfigurationFieldsWithData(this.condition_to_edit))
                }
            },
            condition_selected: function (val) {
                if (this.condition_selected) {
                    this.configuration_fields = Object.values(this.getConditionConfigurationFields(this.condition_selected))
                }
            }
        },
        computed: {
            ...Vuex.mapState(['condition_options']),
            ...Vuex.mapGetters(['getConditionConfigurationFields', 'getConditionConfigurationFieldsWithData', 
                'select_field_is_multiple', 'rolesAsOptions', 'groupMembersAsOptions']),
            condition_display_helper: function() {
                // using condition_to_edit, get condition data from vuex and display it appropriately
                return "Need to fill this out"
            }
        },
        methods: {
            ...Vuex.mapActions(['addCondition', 'updateCondition']),
            add_condition(){
                this.addCondition({ condition_selected : this.condition_selected, configuration : this.configuration_fields,
                        permission : this.permission_to_condition })
                    .then(response => { this.condition_selected = ''; this.$emit("clearState"); })
                    .catch(error => {  this.error_message = error })
            },
            update_condition(){
                this.updateCondition({ condition_to_edit: this.condition_to_edit, configuration : this.configuration_fields,
                    permission : this.permission_to_condition })
                .then(response => { this.$emit("clearState"); })
                .catch(error => {  this.error_message = error })
            },
            // remove_condition() {

                    // ONLY CALLED BY LEADERSHIP INCLUDE

            //     this.updateCondition({ condition_id: this.condition_to_edit, configuration : this.configuration_fields })
            //     .then(response => { this.$emit("clearState"); })
            //     .catch(error => {  this.error_message = error })
            // }
        }
    
    });

</script>